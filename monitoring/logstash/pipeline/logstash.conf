input {
  beats {
    port => 5044
  }
  
  # Logs depuis fichiers
  file {
    path => "/var/log/app/*.log"
    codec => "json"
    start_position => "beginning"
    sincedb_path => "/dev/null"
  }
}

filter {
  # Parse les logs JSON du backend Spring Boot
  if [fields][application] == "hotel-ticket-hub-backend" {
    json {
      source => "message"
      target => "log"
    }
    
    # Extraire les champs importants
    mutate {
      add_field => {
        "application" => "%{[fields][application]}"
        "environment" => "%{[fields][environment]}"
      }
    }
    
    # Parse la date
    date {
      match => [ "log.timestamp", "yyyy-MM-dd HH:mm:ss.SSS" ]
      target => "@timestamp"
    }
    
    # Extraire le niveau de log
    if [log][level] {
      mutate {
        add_field => { "log_level" => "%{[log][level]}" }
      }
    }
    
    # Extraire le logger
    if [log][logger] {
      mutate {
        add_field => { "logger" => "%{[log][logger]}" }
      }
    }
    
    # Extraire le message
    if [log][message] {
      mutate {
        add_field => { "log_message" => "%{[log][message]}" }
      }
    }
    
    # Extraire les exceptions
    if [log][exception] {
      mutate {
        add_field => { "exception" => "%{[log][exception]}" }
      }
    }
    
    # Extraire les métadonnées HTTP
    if [log][http] {
      mutate {
        add_field => { "http_method" => "%{[log][http][method]}" }
        add_field => { "http_path" => "%{[log][http][path]}" }
        add_field => { "http_status" => "%{[log][http][status]}" }
      }
    }
  }
  
  # Géocodage IP (optionnel)
  # geoip {
  #   source => "[log][remote_address]"
  # }
}

output {
  # Envoyer vers Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "hotel-ticket-hub-logs-%{+YYYY.MM.dd}"
    template_name => "hotel-ticket-hub-logs"
  }
  
  # Debug (optionnel)
  # stdout {
  #   codec => rubydebug
  # }
}

