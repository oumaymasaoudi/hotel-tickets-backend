# üöÄ Guide d'Exploitation - TicketHotel

## üìã Vue d'ensemble

**Application:** TicketHotel - Gestion de tickets pour h√¥tels  
**Environnement Staging:**
- Backend: http://13.63.15.86:8081
- Frontend: http://13.50.221.51
- Base de donn√©es: PostgreSQL sur 13.48.83.147

---

## üîß Commandes Essentielles

### V√©rifier l'√©tat du backend

```bash
# Se connecter √† la VM Backend
ssh -i ~/.ssh/oumayma-key.pem ubuntu@13.63.15.86

# V√©rifier les conteneurs
docker ps | grep backend

# V√©rifier les logs
docker logs --tail 50 hotel-ticket-hub-backend-staging

# Health check
curl http://localhost:8081/actuator/health
```

### Red√©marrer le backend

```bash
ssh -i ~/.ssh/oumayma-key.pem ubuntu@13.63.15.86 "cd ~/hotel-ticket-hub-backend && docker compose restart backend"
```

### Tester les endpoints

```bash
# H√¥tels publics
curl http://13.63.15.86:8081/api/hotels/public

# Cat√©gories publiques
curl http://13.63.15.86:8081/api/categories/public

# Health check
curl http://13.63.15.86:8081/actuator/health
```

---

## üîê Gestion des Utilisateurs

### Cr√©er un SuperAdmin

**Option 1: Via l'API (Recommand√©)**
```bash
curl -X POST http://13.63.15.86:8081/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@example.com",
    "password": "Admin123!",
    "fullName": "Super Admin",
    "phone": "+33612345678",
    "roles": ["SUPERADMIN"]
  }'
```

**Option 2: Via SQL (si n√©cessaire)**
```sql
-- Voir scripts/create-superadmin-simple.sql
```

### Se connecter

```bash
curl -X POST http://13.63.15.86:8081/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@example.com",
    "password": "Admin123!"
  }'
```

---

## üé´ Cr√©er un Ticket (Public)

```bash
curl -X POST http://13.63.15.86:8081/api/tickets/public \
  -F "ticket={\"title\":\"Probl√®me de plomberie\",\"description\":\"Fuite d'eau\",\"categoryId\":\"...\",\"hotelId\":\"...\",\"clientEmail\":\"client@example.com\"}" \
  -F "images=@image1.jpg"
```

---

## üè® Cr√©er un H√¥tel (SUPERADMIN)

```bash
# D'abord, obtenir un token JWT via /api/auth/login
TOKEN="votre_token_jwt"

# R√©cup√©rer les plans disponibles
curl -X GET http://13.63.15.86:8081/api/plans \
  -H "Authorization: Bearer $TOKEN"

# Cr√©er un h√¥tel
curl -X POST http://13.63.15.86:8081/api/hotels \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "H√¥tel Example",
    "address": "123 Rue Example",
    "email": "hotel@example.com",
    "phone": "+33612345678",
    "planId": "uuid-du-plan"
  }'
```

---

## üìä Monitoring

### Acc√©der √† Grafana
- URL: http://[MONITORING_VM_IP]:3000
- Dashboard: "Hotel Ticket Hub - Backend Spring Boot"

### M√©triques Prometheus
- URL: http://13.63.15.86:8081/actuator/prometheus

### Logs en temps r√©el
```bash
ssh -i ~/.ssh/oumayma-key.pem ubuntu@13.63.15.86 "docker logs -f hotel-ticket-hub-backend-staging"
```

---

## üêõ D√©pannage

### Backend ne r√©pond pas

1. V√©rifier que le conteneur est d√©marr√©:
   ```bash
   docker ps | grep backend
   ```

2. V√©rifier les logs:
   ```bash
   docker logs hotel-ticket-hub-backend-staging
   ```

3. Red√©marrer:
   ```bash
   docker compose restart backend
   ```

### ERR_CONNECTION_REFUSED

Voir `scripts/FIX-CONNECTION-REFUSED.md`

### Erreur 401/403

V√©rifier que le token JWT est valide et que l'utilisateur a les permissions n√©cessaires.

### Erreur 500

V√©rifier les logs du backend pour plus de d√©tails.

---

## üìö Documentation

- **API Endpoints:** `API-ENDPOINTS.md`
- **√âtat de l'application:** `ETAT-APPLICATION.md`
- **Swagger UI:** http://13.63.15.86:8081/swagger-ui.html

---

## üîÑ Mise √† jour de l'Application

### Via Git (Recommand√©)

```bash
ssh -i ~/.ssh/oumayma-key.pem ubuntu@13.63.15.86 "cd ~/hotel-ticket-hub-backend && git pull origin main && docker compose up -d --build"
```

### Via Pipeline CI/CD

Le pipeline GitHub Actions d√©ploie automatiquement sur push vers `main` ou `develop`.

---

## ‚úÖ Checklist de V√©rification

- [ ] Backend d√©marr√© et accessible
- [ ] Health check retourne `{"status":"UP"}`
- [ ] Endpoints publics fonctionnent (`/api/hotels/public`, `/api/categories/public`)
- [ ] Swagger UI accessible
- [ ] Frontend peut se connecter au backend
- [ ] Base de donn√©es accessible
- [ ] Monitoring fonctionnel (Grafana)
- [ ] Pipeline CI/CD passe

---

**Derni√®re mise √† jour:** 8 F√©vrier 2026
