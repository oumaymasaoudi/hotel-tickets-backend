name: Add Oumayma Key to Frontend

on:
  workflow_dispatch:
    inputs:
      public_key:
        description: 'Clé publique SSH (oumayma-key.pem.pub) - Commence par ssh-rsa ou ssh-ed25519'
        required: true
        type: string

jobs:
  add-key:
    name: Ajouter la clé Oumayma sur la VM Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          # Utiliser la clé SSH de staging (ou créer un secret FRONTEND_SSH_PRIVATE_KEY)
          echo "${{ secrets.STAGING_SSH_PRIVATE_KEY }}" > ~/.ssh/frontend_key
          chmod 600 ~/.ssh/frontend_key
          # Ajouter l'host à known_hosts (VM Backend)
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          # Configuration SSH optimisée
          cat >> ~/.ssh/config << EOF
          Host backend-staging
            HostName ${{ secrets.STAGING_HOST }}
            User ${{ secrets.STAGING_USER }}
            IdentityFile ~/.ssh/frontend_key
            StrictHostKeyChecking no
            UserKnownHostsFile ~/.ssh/known_hosts
            ConnectTimeout 10
            ServerAliveInterval 60
            ServerAliveCountMax 3
          EOF
          chmod 600 ~/.ssh/config
      
      - name: Add Oumayma Public Key via Backend VM
        run: |
          # Se connecter à la VM Backend, puis de là à la VM Frontend
          ssh -F ~/.ssh/config backend-staging bash << 'BACKEND_SCRIPT'
            echo "=== Connexion via VM Backend ==="
            # Tester d'abord si on peut se connecter à la VM Frontend depuis la VM Backend
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 ubuntu@51.21.196.104 "echo 'Connexion OK'" || {
              echo "❌ Impossible de se connecter à la VM Frontend depuis la VM Backend"
              echo "Vérifiez que la VM Backend peut accéder à la VM Frontend"
              exit 1
            }
            
            # Ajouter la clé publique sur la VM Frontend
            PUBLIC_KEY='${{ github.event.inputs.public_key }}'
            ssh -o StrictHostKeyChecking=no ubuntu@51.21.196.104 bash << FRONTEND_SCRIPT
              echo "=== Ajout de la clé publique sur VM Frontend ==="
              echo "\${PUBLIC_KEY}" >> ~/.ssh/authorized_keys
              chmod 600 ~/.ssh/authorized_keys
              echo "✅ Clé ajoutée avec succès"
              echo ""
              echo "=== Clés autorisées ==="
              tail -3 ~/.ssh/authorized_keys
            FRONTEND_SCRIPT
          BACKEND_SCRIPT
        continue-on-error: true
      
      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/frontend_key ~/.ssh/config ~/.ssh/known_hosts

