name: Add Oumayma Key to Backend

on:
  workflow_dispatch:
    inputs:
      public_key:
        description: 'Clé publique SSH (oumayma-key.pem.pub) - Commence par ssh-rsa ou ssh-ed25519'
        required: true
        type: string

jobs:
  add-key:
    name: Ajouter la clé Oumayma sur la VM Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_PRIVATE_KEY }}" > ~/.ssh/backend_key
          chmod 600 ~/.ssh/backend_key
          # Ajouter l'host à known_hosts
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          # Configuration SSH optimisée
          cat >> ~/.ssh/config << EOF
          Host backend-staging
            HostName ${{ secrets.STAGING_HOST }}
            User ${{ secrets.STAGING_USER }}
            IdentityFile ~/.ssh/backend_key
            StrictHostKeyChecking no
            UserKnownHostsFile ~/.ssh/known_hosts
            ConnectTimeout 10
            ServerAliveInterval 60
            ServerAliveCountMax 3
          EOF
          chmod 600 ~/.ssh/config
      
      - name: Add Oumayma Public Key
        run: |
          ssh -F ~/.ssh/config backend-staging << EOF
            echo "=== Ajout de la clé publique ==="
            echo "${{ github.event.inputs.public_key }}" >> ~/.ssh/authorized_keys
            chmod 600 ~/.ssh/authorized_keys
            echo "✅ Clé ajoutée avec succès"
            echo ""
            echo "=== Clés autorisées ==="
            tail -3 ~/.ssh/authorized_keys
          EOF
        continue-on-error: true
      
      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/backend_key ~/.ssh/config ~/.ssh/known_hosts

