name: Backend - Staging Deploy

on:
  push:
    branches: [ develop ]
    paths:
      - '**'
      - '.github/workflows/backend-staging.yml'

env:
  JAVA_VERSION: '17'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven
          cache-dependency-path: pom.xml

      - name: Build (skip tests optional)
        run: mvn -B clean package -DskipTests

      - name: Upload jar
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: target/*.jar
          retention-days: 7

  deploy-staging:
    runs-on: ubuntu-latest
    needs: build
    environment: staging
    steps:
      - name: Download jar
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: artifacts

      - name: Pick jar
        run: |
          JAR_FILE=$(ls artifacts/*.jar | head -n 1)
          echo "JAR_FILE=$JAR_FILE" >> $GITHUB_ENV
          echo "Using: $JAR_FILE"

      - name: Copy jar to staging
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          source: "${{ env.JAR_FILE }}"
          target: "/tmp/"
          strip_components: 1

      - name: Restart service (staging)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          script: |
            set -e
            sudo systemctl stop hotel-ticket-hub-backend-staging || true
            sudo mkdir -p /opt/hotel-ticket-hub-backend-staging
            sudo mv /tmp/*.jar /opt/hotel-ticket-hub-backend-staging/app.jar
            sudo chown ubuntu:ubuntu /opt/hotel-ticket-hub-backend-staging/app.jar
            sudo chmod 755 /opt/hotel-ticket-hub-backend-staging/app.jar
            sudo systemctl start hotel-ticket-hub-backend-staging
            sleep 3
            sudo systemctl status hotel-ticket-hub-backend-staging --no-pager

