name: Check Backend Status

on:
  workflow_dispatch:  # D√©clenchement manuel depuis GitHub Actions UI

jobs:
  check-backend:
    name: V√©rifier l'√©tat du Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 13.49.44.219 >> ~/.ssh/known_hosts 2>/dev/null || true
      
      - name: Check Backend Status
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@13.49.44.219 << 'EOF'
            echo "=========================================="
            echo "üîç V√âRIFICATION DU BACKEND"
            echo "=========================================="
            echo ""
            
            echo "1Ô∏è‚É£ Conteneurs Docker:"
            docker ps | grep backend || echo "   ‚ùå Backend non d√©marr√©"
            echo ""
            
            echo "2Ô∏è‚É£ Port 8081:"
            sudo ss -tlnp | grep 8081 || echo "   ‚ùå Port 8081 non utilis√©"
            echo ""
            
            echo "3Ô∏è‚É£ Test local (health):"
            curl -s -o /dev/null -w "   HTTP Status: %{http_code}\n" http://localhost:8081/actuator/health || echo "   ‚ùå Backend non accessible localement"
            echo ""
            
            echo "4Ô∏è‚É£ Test local (prometheus):"
            curl -s http://localhost:8081/actuator/prometheus | head -5 || echo "   ‚ùå M√©triques Prometheus non accessibles"
            echo ""
            
            echo "5Ô∏è‚É£ Logs r√©cents (derni√®res 50 lignes avec erreurs):"
            docker logs hotel-ticket-hub-backend --tail=50 2>&1 | grep -i "error\|exception\|500\|actuator\|prometheus" | tail -20 || docker logs hotel-ticket-hub-backend --tail=20 2>&1 | tail -10
            echo ""
            
            echo "6Ô∏è‚É£ Test d√©taill√© Prometheus endpoint:"
            curl -v http://localhost:8081/actuator/prometheus 2>&1 | head -30 || echo "   ‚ùå Erreur lors du test"
            echo ""
            
            echo "7Ô∏è‚É£ Configuration Docker Compose:"
            if [ -f /opt/backend/docker-compose.yml ]; then
              echo "   ‚úÖ docker-compose.yml existe"
              grep -A 2 "ports:" /opt/backend/docker-compose.yml | head -3 || echo "   ‚ö†Ô∏è Configuration ports non trouv√©e"
            else
              echo "   ‚ùå docker-compose.yml non trouv√©"
            fi
            echo ""
            
            echo "=========================================="
          EOF
        continue-on-error: true
      
      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa

