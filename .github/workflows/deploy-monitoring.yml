name: Deploy Monitoring Stack

on:
  workflow_dispatch:  # D√©clenchement manuel
  push:
    branches: [ main, develop ]
    paths:
      - 'monitoring/**'
      - '.github/workflows/deploy-monitoring.yml'

env:
  MONITORING_DIR: /opt/monitoring

jobs:
  deploy-monitoring:
    name: Deploy Monitoring to Ansible VM
    runs-on: ubuntu-latest
    environment: monitoring
    timeout-minutes: 15
    concurrency:
      group: deploy-monitoring
      cancel-in-progress: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Verify monitoring files exist
        run: |
          if [ ! -d "monitoring" ]; then
            echo "ERROR: monitoring directory not found!"
            exit 1
          fi
          echo "‚úÖ Monitoring directory found"
          echo "üìÅ Files to deploy:"
          find monitoring -type f -name "*.yml" -o -name "*.yaml" -o -name "*.conf" | head -20

      - name: Setup SSH Config
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.MONITORING_SSH_PRIVATE_KEY }}" > ~/.ssh/monitoring_key
          chmod 600 ~/.ssh/monitoring_key
          # Ajouter l'host √† known_hosts
          ssh-keyscan -H ${{ secrets.MONITORING_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          # Configuration SSH optimis√©e
          cat >> ~/.ssh/config << EOF
          Host monitoring-vm
            HostName ${{ secrets.MONITORING_HOST }}
            User ${{ secrets.MONITORING_USER }}
            IdentityFile ~/.ssh/monitoring_key
            StrictHostKeyChecking no
            UserKnownHostsFile ~/.ssh/known_hosts
            ConnectTimeout 10
            ServerAliveInterval 60
            ServerAliveCountMax 3
          EOF
          chmod 600 ~/.ssh/config

      - name: Copy monitoring files to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.MONITORING_HOST }}
          username: ${{ secrets.MONITORING_USER }}
          key: ${{ secrets.MONITORING_SSH_PRIVATE_KEY }}
          source: "monitoring/"
          target: "${{ env.MONITORING_DIR }}/"
          strip_components: 1  # Enlever le pr√©fixe "monitoring/"
          timeout: 60s
          command_timeout: 30s
          debug: false
          use_insecure_cipher: false
          cipher: ["aes128-ctr", "aes192-ctr", "aes256-ctr"]
          # Exclure les fichiers inutiles
          rm: false

      - name: Deploy Monitoring Stack
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.MONITORING_HOST }}
          username: ${{ secrets.MONITORING_USER }}
          key: ${{ secrets.MONITORING_SSH_PRIVATE_KEY }}
          timeout: 300s
          command_timeout: 120s
          debug: false
          use_insecure_cipher: false
          cipher: ["aes128-ctr", "aes192-ctr", "aes256-ctr"]
          script: |
            set -euo pipefail
            cd ${{ env.MONITORING_DIR }}
            
            echo "üîç V√©rification des fichiers..."
            if [ ! -f "docker-compose.monitoring.yml" ]; then
              echo "ERROR: docker-compose.monitoring.yml not found!"
              exit 1
            fi
            
            # Utiliser prometheus-remote.yml si disponible (pour VM s√©par√©e)
            if [ -f "prometheus/prometheus-remote.yml" ]; then
              echo "‚úÖ Utilisation de prometheus-remote.yml (VM s√©par√©e)"
              cp prometheus/prometheus-remote.yml prometheus/prometheus.yml
            fi
            
            echo "üõë Arr√™t des services existants..."
            docker compose -f docker-compose.monitoring.yml down 2>/dev/null || true
            
            echo "üì• Pull des images Docker..."
            docker compose -f docker-compose.monitoring.yml pull
            
            echo "üöÄ D√©marrage de la stack de monitoring..."
            docker compose -f docker-compose.monitoring.yml up -d
            
            echo "‚è≥ Attente du d√©marrage (15s)..."
            sleep 15
            
            echo "üìã Statut des conteneurs:"
            docker compose -f docker-compose.monitoring.yml ps
            
            echo "‚úÖ V√©rification des services..."
            # V√©rifier Prometheus
            if docker ps | grep -q prometheus; then
              echo "‚úÖ Prometheus est en cours d'ex√©cution"
            else
              echo "‚ùå Prometheus n'est pas d√©marr√©"
              docker compose -f docker-compose.monitoring.yml logs prometheus | tail -20
              exit 1
            fi
            
            # V√©rifier Grafana
            if docker ps | grep -q grafana; then
              echo "‚úÖ Grafana est en cours d'ex√©cution"
            else
              echo "‚ùå Grafana n'est pas d√©marr√©"
              docker compose -f docker-compose.monitoring.yml logs grafana | tail -20
              exit 1
            fi
            
            echo "üìã Logs r√©cents (derni√®res 10 lignes):"
            docker compose -f docker-compose.monitoring.yml logs --tail=10
            
            echo "‚úÖ Monitoring stack d√©ploy√© avec succ√®s!"

      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/monitoring_key ~/.ssh/config ~/.ssh/known_hosts

